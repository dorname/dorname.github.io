<!DOCTYPE html>
<html>
  <head>
    
    <title>Git对象及其存储结构 | Keep learning and trying</title>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
    
      
        <link
          rel="stylesheet alternate"
          
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          
          id="default"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/cerulean/bootstrap.min.css"
          
          id="cerulean"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/cosmo/bootstrap.min.css"
          
          id="cosmo"
          class="alternate"
        >
      
        <link
          rel="stylesheet"
          
          href="https://bootswatch.com/5/cyborg/bootstrap.min.css"
          
          id="cyborg"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/darkly/bootstrap.min.css"
          
          id="darkly"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/flatly/bootstrap.min.css"
          
          id="flatly"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/journal/bootstrap.min.css"
          
          id="journal"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/litera/bootstrap.min.css"
          
          id="litera"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/lumen/bootstrap.min.css"
          
          id="lumen"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/lux/bootstrap.min.css"
          
          id="lux"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/materia/bootstrap.min.css"
          
          id="materia"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/minty/bootstrap.min.css"
          
          id="minty"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/morph/bootstrap.min.css"
          
          id="morph"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/pulse/bootstrap.min.css"
          
          id="pulse"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/quartz/bootstrap.min.css"
          
          id="quartz"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/sandstone/bootstrap.min.css"
          
          id="sandstone"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/simplex/bootstrap.min.css"
          
          id="simplex"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/sketchy/bootstrap.min.css"
          
          id="sketchy"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/slate/bootstrap.min.css"
          
          id="slate"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/solar/bootstrap.min.css"
          
          id="solar"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/spacelab/bootstrap.min.css"
          
          id="spacelab"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/superhero/bootstrap.min.css"
          
          id="superhero"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/united/bootstrap.min.css"
          
          id="united"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/vapor/bootstrap.min.css"
          
          id="vapor"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/yeti/bootstrap.min.css"
          
          id="yeti"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/zephyr/bootstrap.min.css"
          
          id="zephyr"
          class="alternate"
        >
      
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    
    <script src="https://dorname.github.io/js/topic.js"></script>
    
    
    <script src="https://dorname.github.io/js/theme.js"></script>
    
    
    <script src="https://dorname.github.io/js/scheme.js"></script>
    
    <script src="https://dorname.github.io/js/blockquote.js"></script>
    <script src="https://dorname.github.io/js/img.js"></script>
    
    <script defer src="https://dorname.github.io/elasticlunr.min.js"></script>
    <script defer src="https://dorname.github.io/search_index.en.js"></script>
    <script src="https://dorname.github.io/js/search.js"></script>
    
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>    
    <!-- <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: true });
    </script>   -->
  </head>
  <body class="d-flex flex-column min-vh-100">
    
      <div class="w-100">
        <img src="https://dorname.github.io/img/banner.jpeg" class="w-100" />
      </div>
    
    
    
    
    <nav class="
      navbar
      navbar-expand-lg
      navbar-dark
      bg-dark
    ">
      <div class="container-fluid">
        <a class="navbar-brand"
          href="https:&#x2F;&#x2F;dorname.github.io&#x2F;"
          title="主页"
        >Keep learning and trying</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarColor02"
          aria-controls="navbarColor02"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarColor02">
          <ul class="navbar-nav me-auto">
            
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="https:&#x2F;&#x2F;dorname.github.io&#x2F;authors"
                >作者</a>
              </li>
            
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="https:&#x2F;&#x2F;dorname.github.io&#x2F;about"
                >关于</a>
              </li>
            
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="https:&#x2F;&#x2F;dorname.github.io&#x2F;tags"
                >相关主题</a>
              </li>
            
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="https:&#x2F;&#x2F;github.com&#x2F;dorname?tab=repositories"
                >Github</a>
              </li>
            
            
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="navbarDropdown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  博客分类
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;rust"
                        onclick="switchTopic('Rust学习')"
                      >Rust学习</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;articles"
                        onclick="switchTopic('未分类博客')"
                      >未分类博客</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;js_learning"
                        onclick="switchTopic('js学习')"
                      >Js学习</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;webAssembly_rust_and_extJs-lab"
                        onclick="switchTopic('Extjs&#x2F;Rust&#x2F;WASM实验')"
                      >Extjs&#x2F;rust&#x2F;wasm实验</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;blockchain"
                        onclick="switchTopic('区块链')"
                      >区块链</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;mega_git"
                        onclick="switchTopic('Mega')"
                      >Mega</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;distributed_system"
                        onclick="switchTopic('分布式理论')"
                      >分布式理论</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;docker"
                        onclick="switchTopic('Docker容器')"
                      >Docker容器</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;kubernetes"
                        onclick="switchTopic('k8s')"
                      >K8s</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;gradle"
                        onclick="switchTopic('gradle')"
                      >Gradle</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;java"
                        onclick="switchTopic('java')"
                      >Java</a>
                    </li>
                  
                </ul>
              </li>
            
            
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="navbarDropdown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  选择一个主题
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('default')"
                      >Default</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('cerulean')"
                      >Cerulean</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('cosmo')"
                      >Cosmo</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('cyborg')"
                      >Cyborg</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('darkly')"
                      >Darkly</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('flatly')"
                      >Flatly</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('journal')"
                      >Journal</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('litera')"
                      >Litera</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('lumen')"
                      >Lumen</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('lux')"
                      >Lux</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('materia')"
                      >Materia</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('minty')"
                      >Minty</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('morph')"
                      >Morph</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('pulse')"
                      >Pulse</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('quartz')"
                      >Quartz</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('sandstone')"
                      >Sandstone</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('simplex')"
                      >Simplex</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('sketchy')"
                      >Sketchy</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('slate')"
                      >Slate</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('solar')"
                      >Solar</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('spacelab')"
                      >Spacelab</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('superhero')"
                      >Superhero</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('united')"
                      >United</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('vapor')"
                      >Vapor</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('yeti')"
                      >Yeti</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('zephyr')"
                      >Zephyr</a>
                    </li>
                  
                </ul>
              </li>
            
            
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="navbarDropdown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  选择一个Scheme颜色
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('dark')"
                      >Dark</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('light')"
                      >Light</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('primary')"
                      >Primary</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('primary inverted')"
                      >Primary inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('secondary')"
                      >Secondary</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('secondary inverted')"
                      >Secondary inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('success')"
                      >Success</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('success inverted')"
                      >Success inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('danger')"
                      >Danger</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('danger inverted')"
                      >Danger inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('warning')"
                      >Warning</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('warning inverted')"
                      >Warning inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('info')"
                      >Info</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('info inverted')"
                      >Info inverted</a>
                    </li>
                  
                </ul>
              </li>
            
          </ul>
          
          <form class="d-flex" onsubmit="return goSearch(event)">
            <input
              class="form-control me-sm-2"
              type="text"
              placeholder="搜索"
            />
            <button
              class="btn btn-secondary my-2 my-sm-0"
              type="submit"
            ><i class="fas fa-search"></i></button>
          </form>
          
        </div>
      </div>
    </nav>
    <main class="container mx-auto my-5">
      
  <h1>Git对象及其存储结构</h1>
  <p class="text-muted">
    
  
  
    
    <a
      class="text-decoration-none text-reset"
      href="https://dorname.github.io/authors/liguangqiao/"
      title="Li Guangqiao"
    ><b>Li Guangqiao</b></a>
   - 
  03&#x2F;11&#x2F;2023

  </p>
  
  <p>
    
      <a
        href="https://dorname.github.io/tags/git/"
        class="badge bg-dark text-decoration-none link-light me-1"
      >
        git
      </a>
    
  </p>
  
  <div class="content">
    <h1 id="gitdui-xiang-ji-qi-cun-chu-jie-gou"><strong>Git对象及其存储结构</strong></h1>
<h2 id="gitdui-xiang">Git对象</h2>
<p><em><strong>Git</strong></em>是一个内容寻址文件系统。其核心思想就是键值对数据库（<em><strong>key-value data store</strong></em>），其核心行为包括：</p>
<ol>
<li>通过向 <em><strong>Git</strong></em> 仓库中插入任意类型的内容，它会返回一个唯一的键（<em><strong>key</strong></em>）。</li>
<li>通过该键可以在任意时刻再次取回该内容。</li>
</ol>
<h3 id="shi-yan-chu-zhen-zhi">实验出真知</h3>
<p>可以通过底层命令 <code>git hash-object</code> 来演示上述效果——该命令可将任意数据保存于 .git/objects 目录（即 <strong>对象数据库</strong>），并返回指向该数据对象的唯一的键。</p>
<ol>
<li>
<p>初始化一个<em><strong>Git</strong></em>仓库</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ git init git_lab
</span></code></pre>
</li>
<li>
<p>检查一下<em><strong>git</strong></em>对象目录(<code>.git/objects</code>)生成了哪些文件夹，通过<code>find</code>命令查看所有文件夹（包含子文件夹）</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ find .git/objects/
</span><span>.git/objects/
</span><span>.git/objects/info
</span><span>.git/objects/pack
</span></code></pre>
</li>
<li>
<p>检查一下<code>.git/objects</code>目录下生成了哪些文件，同样通过<code>find</code>+文件路径+类型参数<code>-type f</code>查看所有文件</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ find .git/objects/ -type f
</span><span>//无输出表示没有文件
</span></code></pre>
</li>
<li>
<p>接下来要开始创建并保存一个文件了，这里简单创建一个文本文件</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>echo &quot;git testing&quot; &gt; git_test.txt
</span></code></pre>
</li>
<li>
<p>保存到<em><strong>git</strong></em>对象目录（<code>.git/objects</code>）。这里使用了<code>git hash-object</code>命令，根据文件<code>git_test.txt</code>的内容生成一串<code>hash</code>值</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>git hash-object -w git_test.txt
</span><span>34e75148c0aeb4efb212f817606d386b15190525
</span></code></pre>
<p><strong>注意：hash值仅与文件内容有关，与名称无关。</strong></p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ echo &quot;git testing&quot; | git hash-object -w --stdin
</span><span>34e75148c0aeb4efb212f817606d386b15190525
</span></code></pre>
</li>
<li>
<p>再次查看<em><strong>git</strong></em>对象目录（<code>.git/objects</code>）下的所有文件</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ find .git/objects/ -type f
</span><span>.git/objects/34/e75148c0aeb4efb212f817606d386b15190525
</span></code></pre>
<p>其中<code>hash</code>值长度40，前两个字符用于子目录命名，后38个字符用于文件命名。<em><strong>hash算法参考SHA-1</strong></em></p>
</li>
<li>
<p>文件<code>git_test.txt</code>内容已经存储到对象数据库中，如果需要从<em><strong>git</strong></em>中取回数据，则需要通过<code>cat-file</code>命令实现（个人理解<code>cat</code>实际就是<code>catch</code>的缩写），其中指定 <code>-p</code> 选项可指示该命令自动判断内容的类型，并为我们显示大致的内容</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ git cat-file -p 34e75148c0aeb4efb212f817606d386b15190525
</span><span>git testing
</span></code></pre>
</li>
<li>
<p>版本变更实验：更新文件<code>git_test.txt</code>的内容并重新保存</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ echo &quot;changing&quot; &gt; git_test.txt
</span><span>$ git hash-object -w git_test.txt
</span><span>372991728e3348b2c32b8dd5377885f2f77173ff
</span></code></pre>
</li>
<li>
<p>查看对象数据库生成文件内容，它记录了该文件的两个不同版本。</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ find .git/objects/ -type f
</span><span>.git/objects/34/e75148c0aeb4efb212f817606d386b15190525
</span><span>.git/objects/37/2991728e3348b2c32b8dd5377885f2f77173ff
</span></code></pre>
</li>
<li>
<p>删除<code>git_test.txt</code>文件，然后尝试回归到第一个版本</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ rm git_test.txt
</span><span>$ git cat-file -p 34e75148c0aeb4efb212f817606d386b15190525 &gt; git_test.txt
</span></code></pre>
</li>
</ol>
<p><strong>这里面其实有个问题：记住文件的每一个版本所对应的 SHA-1 值并不现实；另一个问题是，在这个（简单的版本控制）系统中，文件名并没有被保存——我们仅保存了文件的内容。</strong></p>
<p>上述类型的对象我们称之为 <strong>数据对象（blob object</strong>）。 利用 <code>git cat-file -t</code> 命令，可以让 <em><strong>Git</strong></em> 告诉我们其内部存储的任何对象类型，只要给定该对象的 <em><strong>SHA-1</strong></em> 值：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ git cat-file -t 372991728e3348b2c32b8dd5377885f2f77173ff
</span><span>blob
</span></code></pre>
<h3 id="shu-dui-xiang">树对象</h3>
<p><strong>为了记住每个文件的文件名，GIt引入了树对象</strong></p>
<p><strong>树对象的目标</strong>：解决文件名保存的问题。</p>
<p>下面主要介绍如何创建一个树对象 ：</p>
<p>创建一个树对象。创建一个树对象首先需要通过暂存一些文件来创建一个暂存区。 可以通过底层命令<code> git update-index</code> 为一个单独文件 text.txt 文件的指定版本创建一个暂存区，其中必须指定<code>--add</code>选项。而<code>--cacheinfo</code>选项，则是当添加的文件来源于<strong>Git</strong>数据库中时需要指定的选项。</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>git update-index --add --cacheinfo 100644 \{文件对象hash} 文件名称
</span></code></pre>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>git update-index --add --cacheinfo 100644 \34e75148c0aeb4efb212f817606d386b15190525 git_test.txt
</span></code></pre>
<p>写入暂存区之后，可以通过<code>write-tree</code>命令将暂存区内容写入一个树对象。</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>git write-tree
</span><span>e6de8239772c2c63585dd11b283050631b7f3801
</span></code></pre>
<p><strong>注意：若是要将树对象写入暂存区则需要通过<code>read-tree</code>指令。通常用于将现有的特定树对象，加入到即将生成的新树对象中。</strong></p>
<p>检查当前对象的类型。
<code>git cat-file -t</code></p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>git cat-file -t e6de8239772c2c63585dd11b283050631b7f3801
</span><span>tree
</span></code></pre>
<p>查看树对象的信息</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>git cat-file -p e6de8239772c2c63585dd11b283050631b7f3801
</span><span>100644 blob 34e75148c0aeb4efb212f817606d386b15190525    git_test.txt
</span></code></pre>
<p>综上数据对象维护了文件的内容、树对象维护了文件名称（包含文件名称和文件内容的关系），从使用者的角度来说，我们不仅关心每一次提交的文件内容和文件名称同时我们还关心提交人、提交时间以及提交原因，即我们业务常说的维护人信息为了保存维护人信息，<strong>Git</strong>又引入了提交对象。</p>
<h3 id="ti-jiao-dui-xiang">提交对象</h3>
<p>提交对象的职责是管理和记录维护人信息，通过指令<code>commit-tree</code>来创建。</p>
<p>通过<code>commit-tree</code>指令，我们为一个树对象(tree object)创建一个提交对象。</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>git commit-tree e6de82 -m &quot;first commit&quot;
</span><span>9a0035e9c8b72429ee2b78b7d4a5d4baaa7a0a53
</span><span>git log 9a0035
</span><span>commit 9a0035e9c8b72429ee2b78b7d4a5d4baaa7a0a53
</span><span>Author: LiGuangQiao &lt;lgqfighting@163.com&gt;
</span><span>Date:   Sat Sep 16 11:58:11 2023 +0800
</span><span>
</span><span>    first commit
</span></code></pre>
<p>实际上每次我们运行 <code>git add</code> 和 <code>git commit</code> 命令时，Git 所做的工作实质就是将被改写的文件保存为数据对象，更新暂存区，记录树对象，最后创建一个指明了顶层树对象和父提交的提交对象。 这三种主要的 Git 对象——数据对象、树对象、提交对象——最初均以单独文件的形式保存在 <code>.git/objects</code> 目录下。 </p>
<h2 id="dui-xiang-cun-chu-jie-gou">对象存储结构</h2>
<p><strong>Git</strong>对象具备自己的存储策略，元数据结构如下：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>#{对象类型} #{content.len}\0#{content}
</span></code></pre>
<p>注意：<code>\0</code>表示空字符，代表字符串的结束标记，content 是字节序列不是字符串，故len也是指序列的长度不是对应字符串的长度，通常可能没有影响，但当你去求树对象的hash或者解压缩树对象内容时，就会明白其中的不同，尤其使用rust去实现时。</p>
<p>例如：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>&quot;blob 16\u0000what is up, doc?&quot;
</span></code></pre>
<p>元数据整体由头部信息和存储信息两部分组成，头部信息为对象类型和存储信息长度，最后添加上存储信息的内容。元数据类型为字符串。<strong>Git</strong>将头部信息的存储信息拼接起来后使用<em><strong>SHA-1</strong></em>计算一个<em>hash</em>值。</p>
<p>例子中的计算结果为</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>&quot;bd9dbf5aae1a3862dd1526723246b20206e5fc37&quot;
</span></code></pre>
<p><strong>注意：</strong><code>hash</code>的长度为定长40个字符。</p>
<p>可使用<code>git hash-object</code>命令来做尝试。</p>
<p><strong>注意：请在git的自带工具中使用目前在<code>VSCODE</code>的命令行执行得到的结果是不一样的。具体什么原因还有待研究。</strong></p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>echo -n &quot;what is up, doc?&quot; | git hash-object --stdin
</span><span>&quot;bd9dbf5aae1a3862dd1526723246b20206e5fc37&quot;
</span></code></pre>
<p><img src="../git_hash_object.png" alt="image-20231103124025274" /></p>
<p>上述内容只m是对存储内容转换成一个定长Hash，实际存储到磁盘上仍有后续处理包含压缩处理和分割存储处理。</p>
<ul>
<li>
<p>压缩处理：目标是为了尽可能节省存储空间。<strong>Git</strong>选择的压缩库为<code>zlib</code>。上述例子的压缩结果为</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span> &quot;x\x9CK\xCA\xC9OR04c(\xCFH,Q\xC8,V(-\xD0QH\xC9O\xB6\a\x00_\x1C\a\x9D&quot;
</span></code></pre>
</li>
<li>
<p>分割存储处理：<strong>Git</strong>将存储内容写入磁盘的路径，是对hash值进行了分割，以前两个字符为子目录名称，后38个字符作为子目录内容的文件名称。目测是为了保证磁盘写入性能，由于没有做测试所以尚不清楚。</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>&quot;.git/objects/bd/9dbf5aae1a3862dd1526723246b20206e5fc37&quot;
</span></code></pre>
</li>
</ul>
<h3 id="shu-dui-xiang-de-cun-chu-jie-gou">树对象的存储结构</h3>
<p>基础对象个是如上述树对象的结构为：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>tree #{content.lenght}\0#{content}
</span></code></pre>
<p>树对象的content有进一步的存储结构：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>//#{content}
</span><span>//mode 40000代表树对象 100644代表blob对象
</span><span>#{mode} #{dir1_name or file1_name}#{dir1 or file1&#39;s hash}#{mode} #{dir2_name or file2_name}#{dir2 or file2&#39;s hash}...
</span></code></pre>
<h3 id="ti-jiao-dui-xiang-de-cun-chu-jie-gou">提交对象的存储结构</h3>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>commit #{content.lenght}\0#{mode} #{obj_hash}\nauthor #{用户名称} &lt;#{email}&gt; #{时间戳} #{时区信息}\ncommitter #{用户名称} &lt;#{email}&gt; #{时间戳} #{时区信息}\n\n#{提交信息}\n
</span></code></pre>
<p><strong>注意：</strong><code>\0</code>代表空字符 <code>\n</code>代表换行符</p>
<h3 id="gitcun-chu-dui-xiang-shi-yan-rust">Git存储对象实验（Rust）</h3>
<p>实验目标旨在理解<strong>GIt存储对象</strong>的存储策略。</p>
<h4 id="gou-jian-gitdui-xiang-cun-chu-nei-rong-bing-ji-suan-hash">构建Git对象存储内容并计算hash</h4>
<ol>
<li>
<p>定义存储对象的数据结构。</p>
<p>由上述章节内容归纳，要定义一个结构体，要求可以描述<em>Blob</em>对象、<em>Tree</em>对象和<em>Commit</em>对象存储内容至少需要以下要素信息：存储内容、对象模式、对象类型和子对象集以及文件名称。</p>
<p>**注意:**生产环境中不同对象还是分别创建对应的结构体，此处只做实验帮助理解，不考虑程序冗余。</p>
<table><thead><tr><th>字段编码</th><th>字段名称</th><th>字段类型</th><th>说明</th></tr></thead><tbody>
<tr><td>content</td><td>存储内容</td><td>Vec<u8></td><td>git对象的存储内容</td></tr>
<tr><td>mode</td><td>对象模式</td><td>String</td><td>git的对象模式100644代表blob对象模式、040000代表tree对象模式</td></tr>
<tr><td>data_type</td><td>对象类型</td><td>String</td><td>blob、tree、commit</td></tr>
<tr><td>nodes</td><td>子对象集合</td><td>Vec<Data></td><td>tree、commit 的关联对象</td></tr>
<tr><td>file_name</td><td>文件名称</td><td>String</td><td>文件名成blob使用</td></tr>
<tr><td>msg</td><td>提交信息</td><td>String</td><td>commit 对象使用</td></tr>
</tbody></table>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">derive</span><span>(Clone)]
</span><span style="color:#b48ead;">struct </span><span>Data {
</span><span>    </span><span style="color:#bf616a;">content</span><span>: Vec&lt;</span><span style="color:#b48ead;">u8</span><span>&gt;,
</span><span>    </span><span style="color:#bf616a;">mode</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">data_type</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">nodes</span><span>:Option&lt;Vec&lt;Data&gt;&gt;,
</span><span>    </span><span style="color:#bf616a;">file_name</span><span>:String
</span><span>}
</span><span style="color:#b48ead;">impl </span><span>Data{
</span><span style="color:#65737e;">//获取blob对象的存储内容
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">get_data</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>) -&gt; String {
</span><span>        format!(
</span><span>            &quot;</span><span style="color:#d08770;">{} {}</span><span style="color:#96b5b4;">\x00</span><span style="color:#d08770;">{}</span><span>&quot;,
</span><span>            </span><span style="color:#bf616a;">self</span><span>.data_type,
</span><span>            </span><span style="color:#bf616a;">self</span><span>.content.</span><span style="color:#96b5b4;">len</span><span>(),
</span><span>            </span><span style="color:#bf616a;">self</span><span>.content.</span><span style="color:#96b5b4;">as_bstr</span><span>()
</span><span>        )
</span><span>    }
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">add_node</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>,</span><span style="color:#bf616a;">subnode</span><span>:Data){
</span><span>        </span><span style="color:#b48ead;">if let </span><span>Some(x) = &amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>.nodes{
</span><span>            x.</span><span style="color:#96b5b4;">push</span><span>(subnode);
</span><span>        }</span><span style="color:#b48ead;">else</span><span>{
</span><span>            </span><span style="color:#bf616a;">self</span><span>.nodes = Some(vec![subnode]);
</span><span>        }
</span><span>    }
</span><span style="color:#65737e;">//获取blob对象在树对象中的存储内容
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">get_tree_data</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>) -&gt; Vec&lt;</span><span style="color:#b48ead;">u8</span><span>&gt; {
</span><span>        </span><span style="color:#b48ead;">let</span><span> hash = encode::get_sha_1(</span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#96b5b4;">get_data</span><span>());
</span><span>        println!(&quot;</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;">:</span><span style="color:#96b5b4;">\n</span><span>&quot;,hash);
</span><span>        </span><span style="color:#b48ead;">let</span><span> mode = </span><span style="color:#bf616a;">self</span><span>.mode.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> queue = hex::decode(hash).</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">Invalid hex string</span><span>&quot;);
</span><span>        </span><span style="color:#b48ead;">let</span><span> file_name = </span><span style="color:#bf616a;">self</span><span>.file_name.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> nil = &quot;</span><span style="color:#96b5b4;">\x00</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> space = &quot; &quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        [mode,space,file_name,nil,queue].</span><span style="color:#96b5b4;">concat</span><span>()
</span><span> }
</span><span>}
</span></code></pre>
</li>
<li>
<p>为结构体实现对象的初始化方法。</p>
<p><code>blob</code>对象初始化方法</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">new_blob</span><span>(</span><span style="color:#bf616a;">content</span><span>: Vec&lt;</span><span style="color:#b48ead;">u8</span><span>&gt;, </span><span style="color:#bf616a;">mode</span><span>: String, </span><span style="color:#bf616a;">data_type</span><span>: String,</span><span style="color:#bf616a;">file_name</span><span>:String) -&gt; </span><span style="color:#b48ead;">Self </span><span>{
</span><span>        Data {
</span><span>            content: content,
</span><span>            mode: mode,
</span><span>            data_type: data_type,
</span><span>            nodes:None,
</span><span>            file_name:file_name,
</span><span>            msg:None
</span><span>        }
</span><span>    }
</span></code></pre>
<p>单元测试：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>生成测试用例:
</span><span>文件:test.txt 文件内容:what is up, doc? hash:bd9dbf5aae1a3862dd1526723246b20206e5fc37
</span></code></pre>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">test</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test_blob</span><span>(){
</span><span>    </span><span style="color:#b48ead;">let</span><span> blob_1 = Data::new_blob(&quot;</span><span style="color:#a3be8c;">what is up, doc?</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>(),&quot;</span><span style="color:#a3be8c;">100644</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),&quot;</span><span style="color:#a3be8c;">blob</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),&quot;</span><span style="color:#a3be8c;">test.txt</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>());
</span><span>assert_eq!(encode::sha_1(blob_1.content.</span><span style="color:#96b5b4;">as_bstr</span><span>()));
</span><span>}
</span></code></pre>
<p><code>tree</code>对象初始化方法</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>  </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">new_tree</span><span>(</span><span style="color:#bf616a;">mode</span><span>: String, </span><span style="color:#bf616a;">data_type</span><span>: String,</span><span style="color:#bf616a;">nodes</span><span>:Vec&lt;Data&gt;)-&gt;</span><span style="color:#b48ead;">Self</span><span>{
</span><span>        </span><span style="color:#b48ead;">let</span><span> copy_nodes = nodes.</span><span style="color:#96b5b4;">clone</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> byte_type = data_type.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> space = &quot; &quot;.</span><span style="color:#96b5b4;">to_string</span><span>().</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> nil = </span><span style="color:#b48ead;">b</span><span>&quot;</span><span style="color:#96b5b4;">\x00</span><span>&quot;.</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let mut</span><span> v:Vec&lt;Vec&lt;</span><span style="color:#b48ead;">u8</span><span>&gt;&gt; = vec![byte_type,space,nil];
</span><span>        </span><span style="color:#b48ead;">let mut</span><span> len = </span><span style="color:#d08770;">0</span><span>;
</span><span>        </span><span style="color:#b48ead;">for</span><span> node in nodes{
</span><span>            </span><span style="color:#b48ead;">let mut</span><span> data = node.</span><span style="color:#96b5b4;">get_tree_data</span><span>();
</span><span>            len += data.</span><span style="color:#96b5b4;">len</span><span>();
</span><span>            v.</span><span style="color:#96b5b4;">push</span><span>(data);
</span><span>        }
</span><span>        </span><span style="color:#b48ead;">let</span><span> len = len.</span><span style="color:#96b5b4;">to_string</span><span>().</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        v.</span><span style="color:#96b5b4;">insert</span><span>(</span><span style="color:#d08770;">2</span><span>, len);
</span><span>        Data {
</span><span>            mode:mode,
</span><span>            data_type:data_type,  
</span><span>            nodes:Some(copy_nodes), 
</span><span>            file_name:&quot; &quot;.</span><span style="color:#96b5b4;">to_string</span><span>(), </span><span style="color:#65737e;">//树对象不需要，以空字符串占位避免报错
</span><span>            content:v.</span><span style="color:#96b5b4;">concat</span><span>(),
</span><span>            msg:None
</span><span>        }
</span><span>    }
</span></code></pre>
<p>单元测试：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>生成测试用例:
</span><span>文件:demo.txt 内容:test hash:30d74d258442c7c65512eafab474568dd706c430
</span><span>文件:test.txt 内容:what is up, doc? hash:bd9dbf5aae1a3862dd1526723246b20206e5fc37
</span><span>树对象:dcc20f823c15ba6394596b475c03d08cdc4417a0
</span><span>解析后的树对象内容:
</span><span>tree 72\0100644 demo.txt\00\xD7M%\x84B\xC7\xC6U\x12\xEA\xFA\xB4tV\x8D\xD7\x06\xC40100644 test.txt\0\xBD\x9D\xBFZ\xAE\x1A8b\xDD\x15&amp;r2F\xB2\x02\x06\xE5\xFC7&quot;
</span></code></pre>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">test</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">new_tree_test</span><span>() {
</span><span>    </span><span style="color:#b48ead;">let</span><span> blob_1 = Data::new_blob(
</span><span>        &quot;</span><span style="color:#a3be8c;">what is up, doc?</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">100644</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">blob</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">test.txt</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>    );
</span><span>    </span><span style="color:#b48ead;">let</span><span> blob_2 = Data::new_blob(
</span><span>        &quot;</span><span style="color:#a3be8c;">test</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">100644</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">blob</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">demo.txt</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>    );
</span><span>    </span><span style="color:#b48ead;">let</span><span> tree = Data::new_tree(
</span><span>        &quot;</span><span style="color:#a3be8c;">40000</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">tree</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        vec![blob_2, blob_1],
</span><span>    );
</span><span>    assert_eq!(
</span><span>        encode::sha_1(tree.content),
</span><span>        &quot;</span><span style="color:#a3be8c;">dcc20f823c15ba6394596b475c03d08cdc4417a0</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>()
</span><span>    );
</span><span>}
</span></code></pre>
<p><code>commit</code>对象初始化</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>   </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">new_commit</span><span>(</span><span style="color:#bf616a;">msg</span><span>: String, </span><span style="color:#bf616a;">node</span><span>: Data) -&gt; </span><span style="color:#b48ead;">Self </span><span>{
</span><span>        </span><span style="color:#65737e;">//commit
</span><span>        </span><span style="color:#b48ead;">let</span><span> byte_type = &quot;</span><span style="color:#a3be8c;">commit</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> space = &quot; &quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> nil = &quot;</span><span style="color:#96b5b4;">\x00</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> next_line = &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> author = &quot;</span><span style="color:#a3be8c;">author</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> author_val = &quot;</span><span style="color:#a3be8c;">dorname</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> email_val = &quot;</span><span style="color:#a3be8c;">&lt;lgqfighting@163.com&gt;</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> now = SystemTime::now();
</span><span>        </span><span style="color:#65737e;">// let timestamp = now.duration_since(UNIX_EPOCH).unwrap().as_secs();
</span><span>        </span><span style="color:#b48ead;">let</span><span> timestamp = &quot;</span><span style="color:#a3be8c;">1699193914</span><span>&quot;;
</span><span>        </span><span style="color:#b48ead;">let</span><span> timezone_offset = &quot;</span><span style="color:#a3be8c;">+0800</span><span>&quot;;
</span><span>        </span><span style="color:#b48ead;">let</span><span> node_copy = node.</span><span style="color:#96b5b4;">clone</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> formatted_timestamp = format!(&quot;</span><span style="color:#d08770;">{} {}</span><span>&quot;, timestamp, timezone_offset)
</span><span>            .</span><span style="color:#96b5b4;">as_bytes</span><span>()
</span><span>            .</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> commiter = &quot;</span><span style="color:#a3be8c;">committer</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> node_byte_type = node.data_type.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> node_hash = encode::sha_1(node.content).</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> message = msg.</span><span style="color:#96b5b4;">clone</span><span>().</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        </span><span style="color:#b48ead;">let mut</span><span> v = vec![
</span><span>            node_byte_type,
</span><span>            space.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            node_hash,
</span><span>            next_line.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            author,
</span><span>            space.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            author_val.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            space.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            email_val.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            space.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            formatted_timestamp.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            next_line.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            commiter,
</span><span>            space.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            author_val,
</span><span>            space.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            email_val,
</span><span>            space.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            formatted_timestamp.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            next_line.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            next_line.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>            message,
</span><span>            next_line,
</span><span>        ];
</span><span>        </span><span style="color:#65737e;">// let v = vec![byte_type,space,]
</span><span>        </span><span style="color:#b48ead;">let</span><span> len = v.</span><span style="color:#96b5b4;">clone</span><span>().</span><span style="color:#96b5b4;">concat</span><span>().</span><span style="color:#96b5b4;">len</span><span>().</span><span style="color:#96b5b4;">to_string</span><span>().</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>();
</span><span>        v.</span><span style="color:#96b5b4;">insert</span><span>(</span><span style="color:#d08770;">0</span><span>, byte_type);
</span><span>        v.</span><span style="color:#96b5b4;">insert</span><span>(</span><span style="color:#d08770;">1</span><span>, space);
</span><span>        v.</span><span style="color:#96b5b4;">insert</span><span>(</span><span style="color:#d08770;">2</span><span>, len);
</span><span>        v.</span><span style="color:#96b5b4;">insert</span><span>(</span><span style="color:#d08770;">3</span><span>, nil);
</span><span>        </span><span style="color:#b48ead;">let</span><span> content = v.</span><span style="color:#96b5b4;">concat</span><span>();
</span><span>        Data {
</span><span>            content: content,
</span><span>            mode: &quot;&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>            data_type: &quot;</span><span style="color:#a3be8c;">commit</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>            nodes: Some(vec![node_copy]),
</span><span>            file_name: &quot;&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>            msg: Some(msg),
</span><span>        }
</span><span>    }
</span></code></pre>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>测试用例:
</span><span>提交对象 ff11bc76cb7e488b83369a169e255fb4ca2ee328
</span><span>解压后的存储内容为
</span><span>&quot;commit 171\x00tree dcc20f823c15ba6394596b475c03d08cdc4417a0\nauthor dorname &lt;lgqfighting@163.com&gt; 1699193914 +0800\ncommitter dorname &lt;lgqfighting@163.com&gt; 1699193914 +0800\n\nfirst commit\n&quot;
</span></code></pre>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">test</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">commit_test</span><span>() {
</span><span>    </span><span style="color:#b48ead;">let</span><span> blob_1 = Data::new_blob(
</span><span>        &quot;</span><span style="color:#a3be8c;">what is up, doc?</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">100644</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">blob</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">test.txt</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>    );
</span><span>    </span><span style="color:#b48ead;">let</span><span> blob_2 = Data::new_blob(
</span><span>        &quot;</span><span style="color:#a3be8c;">test</span><span>&quot;.</span><span style="color:#96b5b4;">as_bytes</span><span>().</span><span style="color:#96b5b4;">to_vec</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">100644</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">blob</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">demo.txt</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>    );
</span><span>    </span><span style="color:#b48ead;">let</span><span> tree = Data::new_tree(
</span><span>        &quot;</span><span style="color:#a3be8c;">40000</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        &quot;</span><span style="color:#a3be8c;">tree</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        vec![blob_2, blob_1],
</span><span>    );
</span><span>    </span><span style="color:#b48ead;">let</span><span> commit = Data::new_commit(&quot;</span><span style="color:#a3be8c;">first commit</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(), tree);
</span><span>    assert_eq!(
</span><span>        encode::sha_1(commit.content),
</span><span>        &quot;</span><span style="color:#a3be8c;">ff11bc76cb7e488b83369a169e255fb4ca2ee328</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>()
</span><span>    );
</span><span>}
</span></code></pre>
</li>
</ol>
<h4 id="du-qu-gitdui-xiang-cun-chu-nei-rong">读取Git对象存储内容</h4>
<p>准备测试用例</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>文件:demo.txt 内容:test hash:30d74d258442c7c65512eafab474568dd706c430
</span><span>文件:test.txt 内容:what is up, doc? hash:bd9dbf5aae1a3862dd1526723246b20206e5fc37
</span><span>对应blob对象文件地址
</span><span>.git/objects/30/d74d258442c7c65512eafab474568dd706c430
</span><span>.git/objects/bd/9dbf5aae1a3862dd1526723246b20206e5fc37
</span><span>对应tree对象文件地址
</span><span>.git/objects/dc/c20f823c15ba6394596b475c03d08cdc4417a0
</span><span>对应commit对象地址
</span><span>.git/objects/ff/11bc76cb7e488b83369a169e255fb4ca2ee328
</span></code></pre>
<p>存储内容解压方法:树对象的解压是比较坑的因为hash值必须得二次解析,blob和commit对象可以使用同样的方法解</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">decode_reader</span><span>(</span><span style="color:#bf616a;">bytes</span><span>: &amp;[</span><span style="color:#b48ead;">u8</span><span>]) -&gt; io::Result&lt;String&gt; {
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> z = ZlibDecoder::new(bytes);
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> s = String::new();
</span><span>    z.</span><span style="color:#96b5b4;">read_to_string</span><span>(&amp;</span><span style="color:#b48ead;">mut</span><span> s)?;
</span><span>    Ok(s)
</span><span>}
</span><span>
</span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">decode_tree</span><span>(</span><span style="color:#bf616a;">bytes</span><span>: &amp;[</span><span style="color:#b48ead;">u8</span><span>]) -&gt; io::Result&lt;String&gt; {
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> z = ZlibDecoder::new(bytes);
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> vector = Vec::&lt;</span><span style="color:#b48ead;">u8</span><span>&gt;::new();
</span><span>    z.</span><span style="color:#96b5b4;">read_to_end</span><span>(&amp;</span><span style="color:#b48ead;">mut</span><span> vector)?;
</span><span>    </span><span style="color:#b48ead;">let</span><span> type_data_index = vector.</span><span style="color:#96b5b4;">find_byte</span><span>(</span><span style="color:#d08770;">0x00</span><span>).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span>        </span><span style="color:#b48ead;">let mut</span><span> obj_data_arr: Vec&lt;</span><span style="color:#b48ead;">u8</span><span>&gt; = vector.</span><span style="color:#96b5b4;">drain</span><span>(type_data_index + </span><span style="color:#d08770;">1</span><span>..).</span><span style="color:#96b5b4;">collect</span><span>();
</span><span>        </span><span style="color:#b48ead;">let mut</span><span> type_data = vector.</span><span style="color:#96b5b4;">as_bstr</span><span>().</span><span style="color:#96b5b4;">to_string</span><span>();
</span><span>        type_data+=&quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;;
</span><span>        </span><span style="color:#b48ead;">while let </span><span>Some(index) = obj_data_arr.</span><span style="color:#96b5b4;">find_byte</span><span>(</span><span style="color:#d08770;">0x00</span><span>) {
</span><span>            type_data+=&amp;format!(&quot;</span><span style="color:#a3be8c;">子对象：</span><span style="color:#d08770;">{} </span><span>&quot;,&amp;obj_data_arr[..index].</span><span style="color:#96b5b4;">as_bstr</span><span>());
</span><span>            type_data+=&amp;format!(&quot;</span><span style="color:#a3be8c;">Hash: </span><span style="color:#d08770;">{}</span><span style="color:#96b5b4;">\n</span><span>&quot;,hex::encode(&amp;obj_data_arr[index + </span><span style="color:#d08770;">1</span><span>..index + </span><span style="color:#d08770;">21</span><span>]));
</span><span>            obj_data_arr.</span><span style="color:#96b5b4;">drain</span><span>(..index + </span><span style="color:#d08770;">21</span><span>);
</span><span>        }
</span><span>    Ok(type_data)
</span><span>}
</span></code></pre>
<p>单元测试</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>
</span><span>#[</span><span style="color:#bf616a;">test</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">blob_test</span><span>(){
</span><span>    </span><span style="color:#b48ead;">use </span><span>std::fs;
</span><span>    </span><span style="color:#b48ead;">use </span><span>std::fs::File;
</span><span>    </span><span style="color:#b48ead;">let</span><span> tree_object_file: Vec&lt;</span><span style="color:#b48ead;">u8</span><span>&gt; =
</span><span>        fs::read(&quot;</span><span style="color:#a3be8c;">/project/git_lab/src/testfile/30/d74d258442c7c65512eafab474568dd706c430</span><span>&quot;)
</span><span>            .</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">文件读取成功</span><span>&quot;);
</span><span>    </span><span style="color:#b48ead;">let</span><span> content_byte = </span><span style="color:#96b5b4;">decode_reader</span><span>(&amp;tree_object_file[..]).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    println!(&quot;</span><span style="color:#d08770;">{}</span><span>&quot;, content_byte);
</span><span>}
</span><span style="color:#65737e;">//blob 4test
</span><span>#[</span><span style="color:#bf616a;">test</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">tree_test</span><span>() {
</span><span>    </span><span style="color:#b48ead;">use </span><span>std::fs;
</span><span>    </span><span style="color:#b48ead;">use </span><span>std::fs::File;
</span><span>    </span><span style="color:#b48ead;">let</span><span> tree_object_file: Vec&lt;</span><span style="color:#b48ead;">u8</span><span>&gt; =
</span><span>        fs::read(&quot;</span><span style="color:#a3be8c;">/project/git_lab/src/testfile/dc/c20f823c15ba6394596b475c03d08cdc4417a0</span><span>&quot;)
</span><span>            .</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">文件读取成功</span><span>&quot;);
</span><span>    </span><span style="color:#b48ead;">let</span><span> content_byte = </span><span style="color:#96b5b4;">decode_tree</span><span>(&amp;tree_object_file[..]).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    println!(&quot;</span><span style="color:#d08770;">{}</span><span>&quot;, content_byte);
</span><span>}
</span><span style="color:#65737e;">//output
</span><span style="color:#65737e;">//tree 72
</span><span style="color:#65737e;">//子对象：100644 demo.txt Hash: 30d74d258442c7c65512eafab474568dd706c430
</span><span style="color:#65737e;">//子对象：100644 test.txt Hash: bd9dbf5aae1a3862dd1526723246b20206e5fc37
</span><span>
</span><span>#[</span><span style="color:#bf616a;">test</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">commit_test</span><span>(){
</span><span>    </span><span style="color:#b48ead;">use </span><span>std::fs;
</span><span>    </span><span style="color:#b48ead;">use </span><span>std::fs::File;
</span><span>    </span><span style="color:#b48ead;">let</span><span> tree_object_file: Vec&lt;</span><span style="color:#b48ead;">u8</span><span>&gt; =
</span><span>        fs::read(&quot;</span><span style="color:#a3be8c;">/project/git_lab/src/testfile/ff/11bc76cb7e488b83369a169e255fb4ca2ee328</span><span>&quot;)
</span><span>            .</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">文件读取成功</span><span>&quot;);
</span><span>    </span><span style="color:#b48ead;">let</span><span> content_byte = </span><span style="color:#96b5b4;">decode_reader</span><span>(&amp;tree_object_file[..]).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    println!(&quot;</span><span style="color:#d08770;">{}</span><span>&quot;, content_byte);
</span><span>}
</span><span style="color:#65737e;">//commit 171tree dcc20f823c15ba6394596b475c03d08cdc4417a0
</span><span style="color:#65737e;">//author dorname &lt;lgqfighting@163.com&gt; 1699193914 +0800
</span><span style="color:#65737e;">//committer dorname &lt;lgqfighting@163.com&gt; 1699193914 +0800
</span></code></pre>

  </div>
  
    
  
  <div class="card my-5">
    <div class="row g-0">
      <div class="col-md-4 d-flex align-items-center">
        
  <img
    src="https:&#x2F;&#x2F;dorname.github.io&#x2F;authors&#x2F;liguangqiao&#x2F;harry.jpg"
    class="img-fluid m-auto d-block rounded-circle"
    alt="Li Guangqiao"
  />

      </div>
      <div class="col-md-8">
        <div class="card-body">
          <h5 class="card-title">
            <a
              class="text-decoration-none text-reset"
              href="https://dorname.github.io/authors/liguangqiao/"
            >Li Guangqiao</a>
          </h5>
          <p class="card-text"><p>一个正在转rust的ExtJs前端工程师。迷信rust的整体发展，十分相信rust在各个领域都能发光发热，至少目前rust在很多领域上验证了其安全性、易维护性。但说实话对于我这种菜鸡也是真的难上手哈哈哈~~。
思路总结：</p>
<ul>
<li>万物诞生都会有一个需求来源，每一个改变都是为了解决某个问题，最后应该考虑如何去做</li>
<li>学会掌握一些宏观的知识和理论：系统论、还原论</li>
<li>工程化思想，如何描述整体，从整体架构到模块关联等
故学习东西应该像看地图一样，先看整体了解整体的结构，然后再聚焦每一个模块，对于模块的学习，思考三个问题，“是什么？”、“为什么？”、“怎么做？”；那么设计一个东西时也应该去考虑整体性和关联性。</li>
</ul>
<p>有关于未来的发展，以下是鄙人的粗浅的观点：</p>
<ul>
<li>编程语言未来应该是每个人必备的工具</li>
<li>未来的交互方式应该会以语言交互为主流</li>
<li>下一个去中心化的技术方案出来之前，区块链依然是web3建立价值体系的基础技术方案，如何将现实价值和虚拟价值联通是进入数字世界的一个大难题。</li>
<li>未来注定是AI的世界。AI的进化会伴随绝大部分人的退化，届时除了尖端人才，人们学习的重心会放在何处？</li>
</ul>
</p>
        </div>
      </div>
    </div>
  </div>

  

    </main>
    
  

    
    <footer class="
      mt-auto p-5
      bg-dark
      text-center
      text-white
    ">
      
      <a
        href="mailto:lgqfighting@163.com"
        class="text-reset text-decoration-none"
      >lgqfighting@163.com</a>
      
      
      <div class="mt-2">
        
          <a
            class="text-reset mx-1 bg-transparent"
            href="https:&#x2F;&#x2F;chat.openai.com&#x2F;"
            title="chatGPT"
          ><i class="fab fa-glide-g"></i></a>
        
          <a
            class="text-reset mx-1 bg-transparent"
            href="https:&#x2F;&#x2F;wx.qq.com&#x2F;"
            title="微信"
          ><i class="fab fa-weixin"></i></a>
        
          <a
            class="text-reset mx-1 bg-transparent"
            href="https:&#x2F;&#x2F;www.google.com&#x2F;"
            title="谷歌"
          ><i class="fab fa-google"></i></a>
        
      </div>
      
    </footer>
    
  </body>
</html>
