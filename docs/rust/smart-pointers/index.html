<!DOCTYPE html>
<html>
  <head>
    
    <title>rust学习(六)智能指针 | Keep learning and trying</title>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
    
      
        <link
          rel="stylesheet alternate"
          
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          
          id="default"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/cerulean/bootstrap.min.css"
          
          id="cerulean"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/cosmo/bootstrap.min.css"
          
          id="cosmo"
          class="alternate"
        >
      
        <link
          rel="stylesheet"
          
          href="https://bootswatch.com/5/cyborg/bootstrap.min.css"
          
          id="cyborg"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/darkly/bootstrap.min.css"
          
          id="darkly"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/flatly/bootstrap.min.css"
          
          id="flatly"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/journal/bootstrap.min.css"
          
          id="journal"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/litera/bootstrap.min.css"
          
          id="litera"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/lumen/bootstrap.min.css"
          
          id="lumen"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/lux/bootstrap.min.css"
          
          id="lux"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/materia/bootstrap.min.css"
          
          id="materia"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/minty/bootstrap.min.css"
          
          id="minty"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/morph/bootstrap.min.css"
          
          id="morph"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/pulse/bootstrap.min.css"
          
          id="pulse"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/quartz/bootstrap.min.css"
          
          id="quartz"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/sandstone/bootstrap.min.css"
          
          id="sandstone"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/simplex/bootstrap.min.css"
          
          id="simplex"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/sketchy/bootstrap.min.css"
          
          id="sketchy"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/slate/bootstrap.min.css"
          
          id="slate"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/solar/bootstrap.min.css"
          
          id="solar"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/spacelab/bootstrap.min.css"
          
          id="spacelab"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/superhero/bootstrap.min.css"
          
          id="superhero"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/united/bootstrap.min.css"
          
          id="united"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/vapor/bootstrap.min.css"
          
          id="vapor"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/yeti/bootstrap.min.css"
          
          id="yeti"
          class="alternate"
        >
      
        <link
          rel="stylesheet alternate"
          
          href="https://bootswatch.com/5/zephyr/bootstrap.min.css"
          
          id="zephyr"
          class="alternate"
        >
      
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    
    <script src="https://dorname.github.io/js/topic.js"></script>
    
    
    <script src="https://dorname.github.io/js/theme.js"></script>
    
    
    <script src="https://dorname.github.io/js/scheme.js"></script>
    
    <script src="https://dorname.github.io/js/blockquote.js"></script>
    <script src="https://dorname.github.io/js/img.js"></script>
    
    <script defer src="https://dorname.github.io/elasticlunr.min.js"></script>
    <script defer src="https://dorname.github.io/search_index.en.js"></script>
    <script src="https://dorname.github.io/js/search.js"></script>
    
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>    
    <!-- <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: true });
    </script>   -->
  </head>
  <body class="d-flex flex-column min-vh-100">
    
      <div class="w-100">
        <img src="https://dorname.github.io/img/banner.jpeg" class="w-100" />
      </div>
    
    
    
    
    <nav class="
      navbar
      navbar-expand-lg
      navbar-dark
      bg-dark
    ">
      <div class="container-fluid">
        <a class="navbar-brand"
          href="https:&#x2F;&#x2F;dorname.github.io&#x2F;"
          title="主页"
        >Keep learning and trying</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarColor02"
          aria-controls="navbarColor02"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarColor02">
          <ul class="navbar-nav me-auto">
            
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="https:&#x2F;&#x2F;dorname.github.io&#x2F;authors"
                >作者</a>
              </li>
            
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="https:&#x2F;&#x2F;dorname.github.io&#x2F;about"
                >关于</a>
              </li>
            
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="https:&#x2F;&#x2F;dorname.github.io&#x2F;tags"
                >相关主题</a>
              </li>
            
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="https:&#x2F;&#x2F;github.com&#x2F;dorname?tab=repositories"
                >Github</a>
              </li>
            
            
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="navbarDropdown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  博客分类
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;rust"
                        onclick="switchTopic('Rust学习')"
                      >Rust学习</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;articles"
                        onclick="switchTopic('未分类博客')"
                      >未分类博客</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;js_learning"
                        onclick="switchTopic('js学习')"
                      >Js学习</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;webAssembly_rust_and_extJs-lab"
                        onclick="switchTopic('Extjs&#x2F;Rust&#x2F;WASM实验')"
                      >Extjs&#x2F;rust&#x2F;wasm实验</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;blockchain"
                        onclick="switchTopic('区块链')"
                      >区块链</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;mega_git"
                        onclick="switchTopic('Mega')"
                      >Mega</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;distributed_system"
                        onclick="switchTopic('分布式理论')"
                      >分布式理论</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;docker"
                        onclick="switchTopic('Docker容器')"
                      >Docker容器</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;kubernetes"
                        onclick="switchTopic('k8s')"
                      >K8s</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;gradle"
                        onclick="switchTopic('gradle')"
                      >Gradle</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="https:&#x2F;&#x2F;dorname.github.io&#x2F;java"
                        onclick="switchTopic('java')"
                      >Java</a>
                    </li>
                  
                </ul>
              </li>
            
            
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="navbarDropdown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  选择一个主题
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('default')"
                      >Default</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('cerulean')"
                      >Cerulean</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('cosmo')"
                      >Cosmo</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('cyborg')"
                      >Cyborg</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('darkly')"
                      >Darkly</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('flatly')"
                      >Flatly</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('journal')"
                      >Journal</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('litera')"
                      >Litera</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('lumen')"
                      >Lumen</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('lux')"
                      >Lux</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('materia')"
                      >Materia</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('minty')"
                      >Minty</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('morph')"
                      >Morph</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('pulse')"
                      >Pulse</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('quartz')"
                      >Quartz</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('sandstone')"
                      >Sandstone</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('simplex')"
                      >Simplex</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('sketchy')"
                      >Sketchy</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('slate')"
                      >Slate</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('solar')"
                      >Solar</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('spacelab')"
                      >Spacelab</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('superhero')"
                      >Superhero</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('united')"
                      >United</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('vapor')"
                      >Vapor</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('yeti')"
                      >Yeti</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchTheme('zephyr')"
                      >Zephyr</a>
                    </li>
                  
                </ul>
              </li>
            
            
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="navbarDropdown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  选择一个Scheme颜色
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('dark')"
                      >Dark</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('light')"
                      >Light</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('primary')"
                      >Primary</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('primary inverted')"
                      >Primary inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('secondary')"
                      >Secondary</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('secondary inverted')"
                      >Secondary inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('success')"
                      >Success</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('success inverted')"
                      >Success inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('danger')"
                      >Danger</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('danger inverted')"
                      >Danger inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('warning')"
                      >Warning</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('warning inverted')"
                      >Warning inverted</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('info')"
                      >Info</a>
                    </li>
                  
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="switchScheme('info inverted')"
                      >Info inverted</a>
                    </li>
                  
                </ul>
              </li>
            
          </ul>
          
          <form class="d-flex" onsubmit="return goSearch(event)">
            <input
              class="form-control me-sm-2"
              type="text"
              placeholder="搜索"
            />
            <button
              class="btn btn-secondary my-2 my-sm-0"
              type="submit"
            ><i class="fas fa-search"></i></button>
          </form>
          
        </div>
      </div>
    </nav>
    <main class="container mx-auto my-5">
      
  <h1>rust学习(六)智能指针</h1>
  <p class="text-muted">
    
  
  
    
    <a
      class="text-decoration-none text-reset"
      href="https://dorname.github.io/authors/liguangqiao/"
      title="Li Guangqiao"
    ><b>Li Guangqiao</b></a>
   - 
  16&#x2F;07&#x2F;2023

  </p>
  
  <p>
    
      <a
        href="https://dorname.github.io/tags/rust/"
        class="badge bg-dark text-decoration-none link-light me-1"
      >
        Rust
      </a>
    
  </p>
  
  <div class="content">
    <h1 id="zhi-neng-zhi-zhen"><strong>智能指针</strong></h1>
<h2 id="gai-nian">概念</h2>
<ul>
<li>
<p>指针是包含内存地址的变量，用于引用或只想其他的数据。</p>
</li>
<li>
<p><em><strong>Rust</strong></em>中最常见的指针是引用，而引用只是一种普通指针，除了引用数据之外，没有其他功能，</p>
</li>
<li>
<p>智能指针则是一种数据结构，其行为类似于指针，含有元数据，且在大部分情况下拥有指向的数据，提供内存管理或者绑定检查等附加功能，如管理文件句柄和网络连接。例如<em><strong>Rust</strong></em>中的<em><strong>Vec、String</strong></em>都可以看作智能指针。</p>
<p><em><strong>Rust</strong></em>语言为智能指针封装了两大<em><strong>Trait</strong></em>，当变量实现了这两个<em><strong>Trait</strong></em>后就不再是普通变量：</p>
<ul>
<li>
<p><em><strong>Deref</strong></em></p>
<p>实现了<em><strong>Deref</strong></em>后，变量重载了解引用运算符*****,可以当作普通引用来使用，必要时可以自动或手动实现解引用。</p>
</li>
<li>
<p><em><strong>Drop</strong></em></p>
<p>实现<em><strong>Drop</strong></em>后，变量在超出作用域时会自动从堆中释放，当然还可以自定义实现其他功能，如释放文件或网络连接。</p>
</li>
</ul>
</li>
</ul>
<h2 id="te-zheng">特征</h2>
<ul>
<li>智能指针在大部分情况下具有其所指向数据的所有权</li>
<li>智能指针是一种数据结构，一般使用结构体来实现</li>
<li>智能指针实现了Deref和Drop两个大trait</li>
</ul>
<table><thead><tr><th>名称</th><th>描述</th><th>实际作用</th></tr></thead><tbody>
<tr><td><em><strong>Box&lt;T&gt;</strong></em></td><td>一种独占所有权的智能指针</td><td>指向存储在堆上且类型为T的数据</td></tr>
<tr><td><em><strong>Rc&lt;T&gt;</strong></em></td><td>一种共享所有权的计数智能指针</td><td>用于记录存储在堆上的值的引用数</td></tr>
<tr><td><em><strong>Arc&lt;T&gt;</strong></em></td><td>一种线程安全的共享所有权的计数智能指针</td><td>可用于多线程</td></tr>
<tr><td><em><strong>Cell&lt;T&gt;</strong></em></td><td>一种提供内部可变性的容器，不是智能指针</td><td>允许借用可变数据，编译时检查，参数T要求实现<em><strong>Copy trait</strong></em></td></tr>
<tr><td><em><strong>RefCell&lt;T&gt;</strong></em></td><td>一种提供内部可变性的容器，不是智能指针</td><td>允许借用可变数据，运行时检查，参数T不要求实现<em><strong>Copy trait</strong></em></td></tr>
<tr><td><em><strong>Weak&lt;T&gt;</strong></em></td><td>一种与***Rc&lt;T&gt;***对应的弱引用类型</td><td>用于解决***RefCell&lt;T&gt;***中出现的循环引用。</td></tr>
<tr><td><em><strong>Cow&lt;T&gt;</strong></em></td><td>是一种写时复制的枚举体智能指针</td><td>我们使用***Cow&lt;T&gt;***主要是为了减少内存分配和复制，***Cow&lt;T&gt;***适用于读多写少的场景。</td></tr>
<tr><td><em><strong>Pin&lt;T&gt;</strong></em></td><td>Rust 标准库中的另一种智能指针类型</td><td>用于解决在异步编程和使用不稳定的 <em><strong>APIs</strong></em> 时，对象被移动的问题。<em><strong>Pin</strong></em> 可以用于固定***（pin）***一个对象的内存地址，确保它不会被移动。</td></tr>
</tbody></table>
<h2 id="zi-ding-yi-zhi-neng-zhi-zhen">自定义智能指针</h2>
<ol>
<li>
<p>定义一个结构体MYBOX</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>std::ops::Deref;
</span><span style="color:#65737e;">//定义一个泛型参数的元组结构体
</span><span style="color:#b48ead;">struct </span><span>MYBOX&lt;T&gt;(T);
</span><span style="color:#65737e;">//为元组结构体实现一个创建实例的方法
</span><span style="color:#b48ead;">impl</span><span>&lt;T&gt; MYBOX&lt;T&gt;  {
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#bf616a;">x</span><span>:T) -&gt; </span><span style="color:#b48ead;">Self</span><span>{
</span><span>        </span><span style="color:#b48ead;">Self</span><span>(x)
</span><span>    }
</span><span>}
</span></code></pre>
</li>
<li>
<p>结构体实现<em><strong>Deref</strong></em>特征</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">impl</span><span>&lt;T&gt; Deref </span><span style="color:#b48ead;">for </span><span>MYBOX&lt;T&gt; {
</span><span>    </span><span style="color:#b48ead;">type </span><span>Target = T;
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">deref</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>) -&gt; &amp;</span><span style="color:#b48ead;">Self::</span><span>Target {
</span><span>        &amp;</span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#d08770;">0
</span><span>    }
</span><span>}
</span></code></pre>
</li>
<li>
<p>测试解引用</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">test</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test</span><span>(){
</span><span>    </span><span style="color:#b48ead;">let</span><span> x = </span><span style="color:#d08770;">MYBOX</span><span>::new(</span><span style="color:#d08770;">21</span><span>);
</span><span>    println!(&quot;</span><span style="color:#d08770;">{:?}</span><span>&quot;,*x);
</span><span>}
</span></code></pre>
</li>
<li>
<p>结构体实现<em><strong>Drop</strong></em>特征</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">impl </span><span>&lt;T&gt; Drop </span><span style="color:#b48ead;">for </span><span>MYBOX&lt;T&gt; {
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">drop</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>) {
</span><span>        println!(&quot;</span><span style="color:#a3be8c;">ALREADY DROP</span><span>&quot;)
</span><span>    }
</span><span>}
</span></code></pre>
</li>
</ol>
<h2 id="yin-yong-ji-shu-zhi-neng-zhi-zhen"><strong>引用计数智能指针</strong></h2>
<p><strong>所有权系统规则规定了一个值在任意时刻只能有一个所有者，但在有些场景下，我们又需要让值具有多个所有者</strong></p>
<p>故为了应对这种情况，所以<em><strong>Rust</strong></em>提供了<em><strong>Rc</strong></em>智能指针，<em><strong>Rc</strong></em>是一种可共享的引用计数智能指针，能产生多所有权值。
<em><strong>引用计数意味着通过记录值得引用数来判断值是否仍在使用，如果引用数时0，就表示值可以被清理</strong></em></p>
<p>所有权共享可以理解成教室里的灯，最后离开教室的人负责关灯，同理，在<em><strong>Rc</strong></em>的各个使用者中，只有最后一个使用者会清理数据。克隆<em><strong>Rc</strong></em>会增加引用计数，就像教师里新来了一个人一样。</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#65737e;">// 创建一个 Rc 实例 one，包装整数值 1
</span><span style="color:#b48ead;">let</span><span> one = Rc::new(</span><span style="color:#d08770;">1</span><span>); 
</span><span style="color:#65737e;">// 克隆 Rc 实例 one，创建另一个指向同一资源的 Rc 实例 another_one
</span><span style="color:#b48ead;">let</span><span> another_one = one.</span><span style="color:#96b5b4;">clone</span><span>(); 
</span><span style="color:#65737e;">// 打印引用计数的值
</span><span>println!(&quot;</span><span style="color:#a3be8c;">count: </span><span style="color:#d08770;">{}</span><span>&quot;, Rc::strong_count(&amp;another_one)); 
</span><span style="color:#65737e;">//count: 2
</span></code></pre>
<p><em><strong>注意：Rc可以共享所有权但进限制于单进程环境，为了解决多进程情况下所有权机制共享问题于是诞生了Arc（原子引用计数）</strong></em></p>
<h2 id="yuan-zi-yin-yong-ji-shu-zhi-neng-zhi-zhen"><strong>原子引用计数智能指针</strong></h2>
<p><em><strong>Arc（原子引用计数智能指针）<em><strong>实际上是</strong></em>Rust</strong></em>提供的线程安全的<em><strong>Rc</strong></em>版本</p>
<p><em><strong>Arc特点：</strong></em></p>
<ul>
<li><em><strong>Arc</strong></em>在堆上分配了一个共享所有权的<em><strong>T</strong></em>类型</li>
<li>在<em><strong>Arc</strong></em>上调用clone函数会产生一个新的<em><strong>Arc</strong></em>，它指向与原<em><strong>Arc</strong></em>相同的堆，同时增加引用计数。</li>
<li><em><strong>Arc</strong></em>默认是不可变的，要想在多个线程间修改<em><strong>Arc</strong></em>，就需要配合锁机制，如<em><strong>Mutex</strong></em>。</li>
</ul>
<p><em><strong>注意：Rc和Arc默认不能改变内部值，但有时修改内部值又是必需的，为了解决此问题 Rust提供了两个具有内部可变性的容器Cell和RefCell。内部可变性是Rust中的一个设计模式，允许在拥有不可变引用时修改数据，但通常这是不被借用规则允许的，为此该模式必须通过UnSafe Rust实现，在unsafe块内执行</strong></em></p>
<h2 id="cell-t-he-refcell-t"><em><strong>Cell&lt;T&gt;和RefCell&lt;T&gt;</strong></em></h2>
<p><em><strong>Cell的方法特点：</strong></em></p>
<ul>
<li>对于实现了<em><strong>Copy特性</strong></em>的内部值类型，<em>get</em>方法可以直接查看内部值</li>
<li>对于实现了<em><strong>Default</strong></em>特性的数据类型，<em>take</em>方法会用默认值替换内部值</li>
<li>对于所有数据类型，<em>replace</em>方法会替换并返回被替换的值</li>
<li><em><strong>into_inner</strong></em>方法则消费<em><strong>Cell</strong></em>并返回内部值</li>
</ul>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> a = Cell::new(</span><span style="color:#d08770;">2</span><span>);
</span><span>	println!(&quot;</span><span style="color:#a3be8c;">get:</span><span style="color:#d08770;">{}</span><span>&quot;,a.</span><span style="color:#96b5b4;">get</span><span>());
</span><span>    a.</span><span style="color:#96b5b4;">set</span><span>(</span><span style="color:#d08770;">6</span><span>);
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">get:</span><span style="color:#d08770;">{}</span><span>&quot;,a.</span><span style="color:#96b5b4;">get</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">take out:</span><span style="color:#d08770;">{}</span><span>&quot;,a.</span><span style="color:#96b5b4;">take</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">take in:</span><span style="color:#d08770;">{}</span><span>&quot;,a.</span><span style="color:#96b5b4;">get</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">replace out:</span><span style="color:#d08770;">{}</span><span>&quot;,a.</span><span style="color:#96b5b4;">replace</span><span>(</span><span style="color:#d08770;">5</span><span>));
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">replace in:</span><span style="color:#d08770;">{}</span><span>&quot;,a.</span><span style="color:#96b5b4;">get</span><span>());
</span><span>    </span><span style="color:#65737e;">//into_inner()会把a move掉
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">into_inner:</span><span style="color:#d08770;">{}</span><span>&quot;,a.</span><span style="color:#96b5b4;">into_inner</span><span>());
</span></code></pre>
<p><em><strong>Cell</strong></em>相当于在不可变结构体<em>Fields</em>上开了一个后门，从而能够改变内部的某些字段。</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>std::cell::Cell;
</span><span style="color:#b48ead;">use </span><span>std::ops::Deref;
</span><span style="color:#b48ead;">struct </span><span>Grid {
</span><span>    </span><span style="color:#bf616a;">width</span><span>:</span><span style="color:#b48ead;">i32</span><span>,
</span><span>    </span><span style="color:#bf616a;">height</span><span>:Cell&lt;</span><span style="color:#b48ead;">i32</span><span>&gt;
</span><span>}
</span><span style="color:#b48ead;">impl </span><span>Grid {
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">new</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>,</span><span style="color:#bf616a;">w</span><span>:</span><span style="color:#b48ead;">i32</span><span>,</span><span style="color:#bf616a;">h</span><span>:</span><span style="color:#b48ead;">i32</span><span>) -&gt; </span><span style="color:#b48ead;">Self</span><span>{
</span><span>        </span><span style="color:#b48ead;">Self</span><span>{
</span><span>            width:w,
</span><span>            height:Cell::new(h)
</span><span>        }
</span><span>    }
</span><span>
</span><span>}
</span><span style="color:#b48ead;">impl </span><span>Deref </span><span style="color:#b48ead;">for </span><span>Grid {
</span><span>    </span><span style="color:#b48ead;">type </span><span>Target = (</span><span style="color:#b48ead;">i32</span><span>,</span><span style="color:#b48ead;">i32</span><span>);
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">deref</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>) -&gt; &amp;</span><span style="color:#b48ead;">Self::</span><span>Target {
</span><span>    </span><span style="color:#65737e;">// &amp;(self.width, self.height)  cannot return reference to temporary value returns a reference to data owned by the current function
</span><span>        Box::leak(Box::new((</span><span style="color:#bf616a;">self</span><span>.width, </span><span style="color:#bf616a;">self</span><span>.height.</span><span style="color:#96b5b4;">get</span><span>())))
</span><span>    }
</span><span>}
</span><span>#[</span><span style="color:#bf616a;">test</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test</span><span>(){
</span><span>    
</span><span>    </span><span style="color:#b48ead;">let</span><span> grid =  Grid{
</span><span>        width:</span><span style="color:#d08770;">100</span><span>,
</span><span>        height:Cell::new(</span><span style="color:#d08770;">200</span><span>)
</span><span>    };
</span><span>    grid.height.</span><span style="color:#96b5b4;">set</span><span>(</span><span style="color:#d08770;">600</span><span>);
</span><span>    println!(&quot;</span><span style="color:#d08770;">{:?}</span><span>&quot;,*grid);
</span><span>}
</span></code></pre>
<p><em><strong>中间遇到了为Grid实现解引用的问题：cannot return reference to temporary value returns a reference to data owned by the current function</strong></em></p>
<p>由于 <em><strong>Deref trait</strong></em> 的要求，我们不能返回对临时值的引用，而在 <em><strong>deref</strong></em> 方法中返回的是对临时元组*** (self.width, self.height)*** 的引用，这导致了错误。</p>
<p>如果希望在解引用 <em><strong>defGrid</strong></em> 时打印出元组，一种可行的方法是创建一个新的元组并将其返回，而不是返回对临时值的引用。</p>
<p>我们在deref方法中使用 <em><strong>Box::new((self.width, self.height))</strong></em> 创建一个新的元组，并使用 <em><strong>Box::leak</strong></em> 来将其转换为静态引用。这样，我们可以返回对元组的引用，而不是对临时值的引用。</p>
<p>请注意，使用 <em><strong>Box::leak</strong></em> 来转换为静态引用时需要小心，因为它会泄漏内存。在这个例子中，由于元组是一个非常简单的数据结构，我们可以安全地使用 <em><strong>Box::leak</strong></em>。</p>
<p><em><strong>RefCell&lt;T&gt;</strong></em></p>
<p><em><strong>RefCell</strong></em>与<em><strong>Cell</strong></em>的区别和<em><strong>Ref</strong></em>有关。<em><strong>RefCell</strong></em>不是用<em>get</em>和<em>set</em>方法，而是直接通过获取可变引用来修改内部数据。</p>
<p>实验过程中遇到了获取不可变引用和可变引用的无法同时使用的问题</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>  </span><span style="color:#b48ead;">let</span><span> rc = RefCell::new(</span><span style="color:#d08770;">4</span><span>);
</span><span>    </span><span style="color:#65737e;">// 使用 borrow 方法获取不可变引用，注意先获取不可变引用，由于借用规则，不可再通过rc获取可变引用
</span><span>    </span><span style="color:#b48ead;">let</span><span> rc_data = rc.</span><span style="color:#96b5b4;">borrow</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">first try: </span><span style="color:#d08770;">{}</span><span>&quot;, *rc_data);
</span><span>
</span><span>    </span><span style="color:#65737e;">// 在内部作用域中获取可变引用,想法是做隔离，然而事实上rc仍处于被借用状态
</span><span>    {
</span><span>        </span><span style="color:#b48ead;">let mut</span><span> mutable_data = rc.</span><span style="color:#96b5b4;">borrow_mut</span><span>();
</span><span>        *mutable_data += </span><span style="color:#d08770;">10</span><span>;
</span><span>        println!(&quot;</span><span style="color:#a3be8c;">The updated value is: </span><span style="color:#d08770;">{}</span><span>&quot;, *mutable_data);
</span><span>    } 
</span><span>
</span></code></pre>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>thread &#39;smart_points::ref_cell::test&#39; panicked at &#39;already borrowed: BorrowMutError&#39;
</span></code></pre>
<p>要想代码运行成功，事实证明应该包在内部作用域的是获取不可变引用的逻辑</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span> </span><span style="color:#b48ead;">let</span><span> rc = RefCell::new(</span><span style="color:#d08770;">4</span><span>);
</span><span>    </span><span style="color:#65737e;">// 使用 borrow 方法获取不可变引用，注意先获取不可变引用，由于借用规则，不可再通过rc获取可变引用
</span><span>    {
</span><span>        </span><span style="color:#b48ead;">let</span><span> rc_data = rc.</span><span style="color:#96b5b4;">borrow</span><span>();
</span><span>        println!(&quot;</span><span style="color:#a3be8c;">first try: </span><span style="color:#d08770;">{}</span><span>&quot;, *rc_data);
</span><span>    }
</span><span>    </span><span style="color:#65737e;">// 在内部作用域中获取可变引用
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> mutable_data = rc.</span><span style="color:#96b5b4;">borrow_mut</span><span>();
</span><span>    *mutable_data += </span><span style="color:#d08770;">10</span><span>;
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">The updated value is: </span><span style="color:#d08770;">{}</span><span>&quot;, *mutable_data);
</span></code></pre>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>running 1 test
</span><span>first try: 4
</span><span>The updated value is: 14
</span><span>test smart_points::ref_cell::test ... ok
</span></code></pre>
<p>然而下一步实验证明若是同一个作用域内，先执行获取可变引用再执行不可变引用同样会引起借用恐慌。</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>    </span><span style="color:#b48ead;">let</span><span> rc = RefCell::new(</span><span style="color:#d08770;">4</span><span>);
</span><span>    {
</span><span>        </span><span style="color:#b48ead;">let</span><span> rc_data = rc.</span><span style="color:#96b5b4;">borrow</span><span>();
</span><span>        println!(&quot;</span><span style="color:#a3be8c;">first try: </span><span style="color:#d08770;">{}</span><span>&quot;, *rc_data);
</span><span>    }
</span><span>    </span><span style="color:#65737e;">// 在内部作用域中获取可变引用
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> mutable_data = rc.</span><span style="color:#96b5b4;">borrow_mut</span><span>();
</span><span>    *mutable_data += </span><span style="color:#d08770;">10</span><span>;
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">The updated value is: </span><span style="color:#d08770;">{}</span><span>&quot;, *mutable_data);
</span><span>    
</span><span>    </span><span style="color:#b48ead;">let</span><span> rc_data_one = rc.</span><span style="color:#96b5b4;">borrow</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">final try: </span><span style="color:#d08770;">{}</span><span>&quot;, *rc_data_one);
</span></code></pre>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>first try: 4
</span><span>The updated value is: 14
</span><span>thread &#39;smart_points::ref_cell::test&#39; panicked at &#39;already mutably borrowed: BorrowError&#39;
</span></code></pre>
<p>修正后</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>	</span><span style="color:#b48ead;">let</span><span> rc = RefCell::new(</span><span style="color:#d08770;">4</span><span>);
</span><span>    </span><span style="color:#65737e;">// 在内部作用域中获取不可变引用
</span><span>    {
</span><span>        </span><span style="color:#b48ead;">let</span><span> rc_data = rc.</span><span style="color:#96b5b4;">borrow</span><span>();
</span><span>        println!(&quot;</span><span style="color:#a3be8c;">first try: </span><span style="color:#d08770;">{}</span><span>&quot;, *rc_data);
</span><span>    }
</span><span>    </span><span style="color:#65737e;">// 在内部作用域中获取可变引用
</span><span>    {
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> mutable_data = rc.</span><span style="color:#96b5b4;">borrow_mut</span><span>();
</span><span>    *mutable_data += </span><span style="color:#d08770;">10</span><span>;
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">The updated value is: </span><span style="color:#d08770;">{}</span><span>&quot;, *mutable_data);
</span><span>    }
</span><span>    
</span><span>    </span><span style="color:#b48ead;">let</span><span> rc_data_one = rc.</span><span style="color:#96b5b4;">borrow</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">final try: </span><span style="color:#d08770;">{}</span><span>&quot;, *rc_data_one);
</span></code></pre>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>first try: 4
</span><span>The updated value is: 14
</span><span>final try: 14
</span><span>test smart_points::ref_cell::test ... ok
</span></code></pre>
<p><em><strong>Cell和RefCell的区别：</strong></em></p>
<ul>
<li><em><strong>Cell</strong></em>直接通过替换值来进行修改，<em><strong>RefCell</strong></em>则通过可变引用来进行修改。</li>
<li><em><strong>Cell</strong></em>需要替换和移动值，故<em><strong>Cell</strong></em>适合实现了<em><strong>Copy</strong></em>的数据类型。</li>
<li><em><strong>RefCell</strong></em>并不移动数据，所以<em><strong>RefCell</strong></em>适合未实现<em><strong>Copy</strong></em>的数据类型。</li>
<li>另外，<em><strong>Cell</strong></em>在编译时做检查，<em><strong>RefCell</strong></em>在运行时做检查，使用不当会产生<em><strong>Panic</strong></em>异常。</li>
</ul>
<p><em><strong>Rust</strong></em>本身提供了内存安全的保证，这意味着很难发生内存泄漏，然而<em><strong>RefCell</strong></em>有可能会造成循环引用，进而导致内存泄漏。</p>
<p><em><strong>故为了解决循环引用问题，Rust提供了Weak智能指针</strong></em></p>
<p>通过与<em><strong>Rc</strong></em>对比加强对<em><strong>Weak</strong></em>智能指针的理解：</p>
<ul>
<li><em><strong>Rc</strong></em>每次克隆时都会增加实例的强引用计数<em>strong_count</em>的值，只有<em>strong_count</em>的值为0值，只有<em>strong_count</em>为0时实例才会被清理。循环引用中的<em>strong_count</em>的值永远不会为0。</li>
<li><em><strong>Weak</strong></em>智能指针不增加<em>strong_count</em>的值，而是增加<em>weak_count</em>的值。<em>weak_count</em>无须为0就能清理数据。以此解决循环引用的问题。</li>
</ul>
<p><em><strong>Weak</strong></em> 是 <em><strong>Rust</strong></em> 标准库中的智能指针类型之一，用于解决循环引用***（Circular reference）***问题。循环引用指的是两个或多个对象之间形成了一个环状的引用关系，<em><strong>即 A 引用了 B，B 又引用了 A</strong></em>。如果使用普通的 <em><strong>Rc</strong></em>（引用计数智能指针）来管理对象之间的引用关系，循环引用会导致内存泄漏，因为对象的引用计数永远不会变为零。</p>
<p><em><strong>Weak</strong></em>的特点是：它允许你创建一个弱引用，而不会增加引用计数。这意味着当你使用<em><strong>Weak</strong></em>来建立对象之间的引用关系时，对象之间的循环引用不会导致内存泄漏。当<em><strong>Rc</strong></em> 中的所有强引用都离开作用域时，对象会被正确释放，而不会因为循环引用而造成资源泄漏。</p>
<p><em><strong>Weak</strong></em> 的生命周期是独立于引用计数的，它不会影响对象的引用计数。因此，你需要小心处理 <em><strong>Weak</strong></em>引用，因为当你尝试通过 <em><strong>Weak</strong></em>获取对象的强引用时，对象可能已经被释放，此时获取的值是 <em><strong>None</strong></em>。</p>
<p><em><strong>Weak</strong></em> 智能指针的主要方法有：</p>
<ol>
<li><em><strong>upgrade</strong></em>: 用于尝试将弱引用升级为强引用。它返回 <em><strong>Option&lt;Rc&lt;T&gt;&gt;</strong></em>，如果对象还未被释放，会返回 <em><strong>Some(Rc&lt;T&gt;)</strong></em>，否则返回 <em><strong>None</strong></em>。</li>
<li><em><strong>ptr_eq</strong></em>: 检查两个<em><strong>Weak</strong></em> 引用是否指向相同的对象。</li>
<li><em><strong>strong_count</strong></em>: 获取<em><strong>Weak</strong></em>  引用关联的<em><strong>Rc</strong></em> 引用的数量，即共享指针的引用计数。</li>
<li><em><strong>weak_count</strong></em>: 获取 <em><strong>Weak</strong></em>  引用关联的<em><strong>Rc</strong></em> 引用的弱引用计数。</li>
<li><em><strong>downgrade</strong></em> 方法接收一个 <em><strong>Rc</strong></em> 智能指针作为参数，并返回一个与之关联的 <em><strong>Weak</strong></em>引用。<em><strong>Rc::downgrade</strong></em> 方法不会增加引用计数，因为它创建的是一个弱引用，弱引用不会增加引用计数，也不会阻止对象的释放。这样，当所有<em><strong>Rc</strong></em> 引用离开作用域时，对象的引用计数可能会变为零，并在接下来的垃圾回收过程中被释放</li>
</ol>
<p>在实际使用中，<em><strong>Weak</strong></em>  智能指针通常与 <em><strong>Rc</strong></em>智能指针配合使用，用来构建可循环引用的数据结构，并防止内存泄漏。</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>std::borrow::BorrowMut;
</span><span style="color:#b48ead;">use </span><span>std::cell::RefCell;
</span><span style="color:#b48ead;">use </span><span>std::rc::{Rc,Weak};
</span><span style="color:#b48ead;">struct </span><span>Car{
</span><span>    </span><span style="color:#bf616a;">name</span><span>:String,
</span><span>    </span><span style="color:#bf616a;">wheels</span><span>:RefCell&lt;Vec&lt;Weak&lt;Wheel&gt;&gt;&gt;
</span><span>}
</span><span style="color:#b48ead;">struct </span><span>Wheel{
</span><span>    </span><span style="color:#bf616a;">id</span><span>:</span><span style="color:#b48ead;">i32</span><span>,
</span><span>    </span><span style="color:#bf616a;">car</span><span>:Rc&lt;Car&gt;
</span><span>}
</span><span>#[</span><span style="color:#bf616a;">test</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test</span><span>(){
</span><span>    </span><span style="color:#b48ead;">let</span><span> car:Rc&lt;Car&gt; = Rc::new(
</span><span>        Car {
</span><span>            name: &quot;</span><span style="color:#a3be8c;">Changcheng</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>            wheels:RefCell::new(vec![])
</span><span>        }
</span><span>    );
</span><span>    </span><span style="color:#b48ead;">let</span><span> wheel_one:Rc&lt;Wheel&gt;= Rc::new(Wheel{id:</span><span style="color:#d08770;">1</span><span>,car:Rc::clone(&amp;car)});
</span><span>    </span><span style="color:#b48ead;">let</span><span> wheel_two:Rc&lt;Wheel&gt; = Rc::new(Wheel { id: (</span><span style="color:#d08770;">2</span><span>), car: (Rc::clone(&amp;car)) }); 
</span><span>    </span><span style="color:#65737e;">//可变借用赋值放在内部代码块中可避免与后续的不可变借用产生冲突
</span><span>    { 
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> wheels = car.wheels.</span><span style="color:#96b5b4;">borrow_mut</span><span>();
</span><span>    wheels.</span><span style="color:#96b5b4;">push</span><span>(Rc::downgrade(&amp;wheel_one));
</span><span>    wheels.</span><span style="color:#96b5b4;">push</span><span>(Rc::downgrade(&amp;wheel_two));
</span><span>    }
</span><span>    </span><span style="color:#65737e;">// println!(&quot;{}&quot;,car.name);
</span><span>    </span><span style="color:#65737e;">//不可变借用car.wheels.borrow()
</span><span>    </span><span style="color:#b48ead;">for</span><span> wheel_weak in car.wheels.</span><span style="color:#96b5b4;">borrow</span><span>().</span><span style="color:#96b5b4;">iter</span><span>() {
</span><span>    </span><span style="color:#65737e;">// for wheel_weak in wheels.iter() {
</span><span>        </span><span style="color:#b48ead;">let</span><span> wl = wheel_weak.</span><span style="color:#96b5b4;">upgrade</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>        println!(&quot;</span><span style="color:#a3be8c;">车轮id</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;">,车名name</span><span style="color:#d08770;">{}</span><span>&quot;,wl.id,wl.car.name);
</span><span>    }
</span><span>    println!(&quot;</span><span style="color:#d08770;">{}</span><span>&quot;,Rc::downgrade(&amp;wheel_one).</span><span style="color:#96b5b4;">weak_count</span><span>());
</span><span>}
</span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">*我们通过 Rc::downgrade 创建了弱引用，并使用 upgrade 方法尝试将弱引*用升级为强引用。这样就避免了循环引用导致的内存泄漏。
</span><span style="color:#65737e;">*/
</span></code></pre>
<h2 id="cow-copy-on-write-xie-shi-de-fu-zhi-zhi-zhen"><em><strong>Cow</strong></em>(<em><strong>copy on write</strong></em>)写时的复制指针</h2>
<p><em><strong>Cow</strong></em>不是严格意义上的智能指针，而是一个封装好的枚举类型、</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">pub enum </span><span>Cow&lt;&#39;a,B&gt; where B: a&#39;+ ToOwned +&#39;a + ?Sized{
</span><span>    Borrowed(&amp;</span><span style="color:#b48ead;">&#39;a</span><span> B), </span><span style="color:#65737e;">//包裹引用
</span><span>    Owned(&lt;B as ToOwned&gt;::Owned) </span><span style="color:#65737e;">//包裹所有者
</span><span>}
</span></code></pre>
<ul>
<li>Borrowed的含义是以不可变的方式访问借用内容</li>
<li>Owned的含义是需要可变借用或所有权时克隆一份数据。</li>
</ul>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#65737e;">//写一个过滤字符串空格的函数
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">filter_space</span><span>(</span><span style="color:#bf616a;">src</span><span>: &amp;</span><span style="color:#b48ead;">str</span><span>) -&gt; String {
</span><span>    </span><span style="color:#65737e;">//使用with_capacity函数预置一个src长度大小内存空间，空间具有伸展性，随着字符串的溢出而伸展
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> target = String::with_capacity(src.</span><span style="color:#96b5b4;">len</span><span>());
</span><span>    </span><span style="color:#b48ead;">for</span><span> c in src.</span><span style="color:#96b5b4;">chars</span><span>() {
</span><span>        </span><span style="color:#b48ead;">if </span><span>&#39; &#39; != c {
</span><span>            target.</span><span style="color:#96b5b4;">push</span><span>(c);
</span><span>        }
</span><span>    }
</span><span>    target
</span><span>}
</span><span>
</span><span style="color:#65737e;">//使用枚举智能指针cow
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">filter_space_cow</span><span>&lt;</span><span style="color:#b48ead;">&#39;a</span><span>&gt;(</span><span style="color:#bf616a;">src</span><span>: &amp;</span><span style="color:#b48ead;">&#39;a str</span><span>) -&gt; Cow&lt;</span><span style="color:#b48ead;">&#39;a</span><span>, </span><span style="color:#b48ead;">str</span><span>&gt; {
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> target = String::with_capacity(src.</span><span style="color:#96b5b4;">len</span><span>());
</span><span>    </span><span style="color:#b48ead;">if</span><span> src.</span><span style="color:#96b5b4;">contains</span><span>(&#39; &#39;) {
</span><span>        </span><span style="color:#b48ead;">for</span><span> c in src.</span><span style="color:#96b5b4;">chars</span><span>() {
</span><span>            </span><span style="color:#b48ead;">if </span><span>&#39; &#39; != c {
</span><span>                target.</span><span style="color:#96b5b4;">push</span><span>(c);
</span><span>            }
</span><span>        }
</span><span>        </span><span style="color:#b48ead;">return </span><span>Cow::Owned(target);
</span><span>    }
</span><span>    Cow::Borrowed(src)
</span><span>}
</span></code></pre>
<p>现阶段循环调用测试一下两个函数花费的时间，根据目前接触书本理论的结果，使用<em><strong>Cow</strong></em>的优越性比较高，后续会借助专业的库和工具，从内存消耗和执行时间两个层面去比较。</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">compare</span><span>() {
</span><span>   
</span><span>    </span><span style="color:#b48ead;">let</span><span> input = &quot;</span><span style="color:#a3be8c;">Hello, Rust! This is a test string with spaces.</span><span>&quot;;
</span><span>    </span><span style="color:#b48ead;">let</span><span> iterations = </span><span style="color:#d08770;">1000000</span><span>;
</span><span>  
</span><span>
</span><span>    </span><span style="color:#65737e;">// 使用 Cow 智能指针函数性能测试
</span><span>    </span><span style="color:#b48ead;">let</span><span> start = Instant::now();
</span><span>    </span><span style="color:#b48ead;">for </span><span>_ in </span><span style="color:#d08770;">0</span><span>..iterations {
</span><span>        </span><span style="color:#96b5b4;">filter_space_cow</span><span>(input);
</span><span>    }
</span><span>    </span><span style="color:#b48ead;">let</span><span> duration = start.</span><span style="color:#96b5b4;">elapsed</span><span>();
</span><span>    println!(
</span><span>        &quot;</span><span style="color:#a3be8c;">Cow function: </span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;"> microseconds per iteration</span><span>&quot;,
</span><span>        duration.</span><span style="color:#96b5b4;">as_micros</span><span>() as </span><span style="color:#b48ead;">f64 </span><span>/ iterations as </span><span style="color:#b48ead;">f64
</span><span>    );
</span><span>
</span><span>     </span><span style="color:#65737e;">// 原始函数性能测试
</span><span>    </span><span style="color:#b48ead;">let</span><span> start = Instant::now();
</span><span>    </span><span style="color:#b48ead;">for </span><span>_ in </span><span style="color:#d08770;">0</span><span>..iterations {
</span><span>        </span><span style="color:#96b5b4;">filter_space</span><span>(input);
</span><span>    }
</span><span>    </span><span style="color:#b48ead;">let</span><span> duration = start.</span><span style="color:#96b5b4;">elapsed</span><span>();
</span><span>    println!(
</span><span>        &quot;</span><span style="color:#a3be8c;">Original function: </span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;"> microseconds per iteration</span><span>&quot;,
</span><span>        duration.</span><span style="color:#96b5b4;">as_micros</span><span>() as </span><span style="color:#b48ead;">f64 </span><span>/ iterations as </span><span style="color:#b48ead;">f64
</span><span>    );
</span><span>}
</span></code></pre>
<p>测试结果如下：似乎没有太大的区别，甚至Cow消耗平均时间要多一些。但由于个人的测试函数比较草率，测试结果仅供参考。</p>
<p><img src="https://dorname.github.io/rust/smart-pointers/compare.png" alt="image-20230722160207775" /></p>
<h2 id="pin-t"><em><strong>Pin&lt;T&gt;</strong></em></h2>
<p>是 <em><strong>Rust</strong></em> 标准库中的另一种智能指针类型，它用于解决在异步编程和使用不稳定的*** APIs*** 时，对象被移动（<em><strong>Drop</strong></em>）的问题。它在内存管理方面与其他智能指针类型有所不同</p>
<p>当我们使用 <em><strong>async/await</strong></em> 和 <em><strong>Future</strong></em> 来进行异步编程时，经常需要将 <em><strong>Future</strong></em> 固定在内存中，以确保它在异步执行时不会被移动。这就是 <em><strong>Pin</strong></em> 指针的典型应用场景。</p>
<p>TODO等待后续学习完异步的内容进行实验补充</p>

  </div>
  
    
  
  <div class="card my-5">
    <div class="row g-0">
      <div class="col-md-4 d-flex align-items-center">
        
  <img
    src="https:&#x2F;&#x2F;dorname.github.io&#x2F;authors&#x2F;liguangqiao&#x2F;harry.jpg"
    class="img-fluid m-auto d-block rounded-circle"
    alt="Li Guangqiao"
  />

      </div>
      <div class="col-md-8">
        <div class="card-body">
          <h5 class="card-title">
            <a
              class="text-decoration-none text-reset"
              href="https://dorname.github.io/authors/liguangqiao/"
            >Li Guangqiao</a>
          </h5>
          <p class="card-text"><p>一个正在转rust的ExtJs前端工程师。迷信rust的整体发展，十分相信rust在各个领域都能发光发热，至少目前rust在很多领域上验证了其安全性、易维护性。但说实话对于我这种菜鸡也是真的难上手哈哈哈~~。
思路总结：</p>
<ul>
<li>万物诞生都会有一个需求来源，每一个改变都是为了解决某个问题，最后应该考虑如何去做</li>
<li>学会掌握一些宏观的知识和理论：系统论、还原论</li>
<li>工程化思想，如何描述整体，从整体架构到模块关联等
故学习东西应该像看地图一样，先看整体了解整体的结构，然后再聚焦每一个模块，对于模块的学习，思考三个问题，“是什么？”、“为什么？”、“怎么做？”；那么设计一个东西时也应该去考虑整体性和关联性。</li>
</ul>
<p>有关于未来的发展，以下是鄙人的粗浅的观点：</p>
<ul>
<li>编程语言未来应该是每个人必备的工具</li>
<li>未来的交互方式应该会以语言交互为主流</li>
<li>下一个去中心化的技术方案出来之前，区块链依然是web3建立价值体系的基础技术方案，如何将现实价值和虚拟价值联通是进入数字世界的一个大难题。</li>
<li>未来注定是AI的世界。AI的进化会伴随绝大部分人的退化，届时除了尖端人才，人们学习的重心会放在何处？</li>
</ul>
</p>
        </div>
      </div>
    </div>
  </div>

  

    </main>
    
  

    
    <footer class="
      mt-auto p-5
      bg-dark
      text-center
      text-white
    ">
      
      <a
        href="mailto:lgqfighting@163.com"
        class="text-reset text-decoration-none"
      >lgqfighting@163.com</a>
      
      
      <div class="mt-2">
        
          <a
            class="text-reset mx-1 bg-transparent"
            href="https:&#x2F;&#x2F;chat.openai.com&#x2F;"
            title="chatGPT"
          ><i class="fab fa-glide-g"></i></a>
        
          <a
            class="text-reset mx-1 bg-transparent"
            href="https:&#x2F;&#x2F;wx.qq.com&#x2F;"
            title="微信"
          ><i class="fab fa-weixin"></i></a>
        
          <a
            class="text-reset mx-1 bg-transparent"
            href="https:&#x2F;&#x2F;www.google.com&#x2F;"
            title="谷歌"
          ><i class="fab fa-google"></i></a>
        
      </div>
      
    </footer>
    
  </body>
</html>
